/**
 * prometheus - 普罗米修斯
 * @author 
 * @version v1.0.91
 * @link 
 * @license MIT
 */
define(["angular"],function(e){"use strict";var o=e.module("HB_interceptor",[]).provider("HBInterceptor",[function(){var e=this;this.app=void 0,this.loginPageStr=void 0,this.$get=[function(){return{getAppString:function(){return e.app},getApp:function(){return"admin"===e.app?2:1},getLoginPage:function(){return e.loginPageStr||"/login/index.html"},toLoginPage:function(){window.location.href=this.getLoginPage()}}}]}]).config(["$httpProvider",function(e){e.interceptors.push("ajaxInterceptor")}]).run(["hbLoginService","HBInterceptor","$rootScope","HB_notification","$http",function(e,o,t,r,n){t.$on("event:ajaxRequestErrorResponse",function(o,n){switch(n.code){case 401:e.createLoginForm();break;case 404:r.showTip("请求地址找不到!","error");break;case 500:r.add500Error(t,n);break;case 403:r.showTip("当前请求没权限!","error")}}),t.$on("event:error_5oo_add_error",function(){r.show500Error()}),2===o.getApp()?function(){o.storeVar="adminUserInfo"}():function(){o.storeVar="frontUserInfo"}(),$.ajaxSetup({cache:!1,statusCode:{404:function(e,o,r){t.$broadcast("event:ajaxRequestErrorResponse",{code:404})},401:function(e){t.$broadcast("event:ajaxRequestErrorResponse",{code:401})},500:function(e,o,r,n){t.$broadcast("event:ajaxRequestErrorResponse",{message:e.responseJSON,code:e.status})},403:function(e,o,r,n){t.$broadcast("event:ajaxRequestErrorResponse",{code:403})}}})}]);o.factory("ajaxInterceptor",["$q","$rootScope",function(e,o){var t={request:function(e){return e.url.indexOf("/web/")!==-1&&(e.url.indexOf("?")!==-1?e.url+="&_q_="+Date.now():e.url+="?_q_="+Date.now()),e},responseError:function(t){return o.$broadcast("event:ajaxRequestErrorResponse",{code:t.status,message:t.data}),e.reject(t)}};return t}]).factory("cookieOp",[function(){return{rememberPassword:function(o,t,r){var n=30,a=new Date;a.setTime(a.getTime()+24*n*60*60*1e3);var i=a.toGMTString();if("undefined"!=typeof r){var s=new Date;s.setDate(s.getDate()+r),i=s.toGMTString()}document.cookie=o+"="+e.toJson(t)+";expires="+i+";path=/"},removeFromCookie:function(e){this.rememberPassword(e,1,1,-1)},getUserCookie:function(e){var o,t=new RegExp("(^| )"+e+"=([^;]*)(;|$)");if(o=document.cookie.match(t))return unescape(o[2])}}}]),o.factory("hbLoginService",["$injector","$rootScope","$http","$state","$stateParams","cookieOp","HBInterceptor","$q","$interval","$log",function(o,t,r,n,a,i,s,c,u,l){function g(e){e.rememberPass?i.rememberPassword(s.storeVar,{userName:e.userName,password:e.password}):i.removeFromCookie(s.storeVar)}function p(e,o){var t=c.defer(),a=t.promise,i={style:{marginLeft:"30px",fontSize:"13px",fontWeight:"bold"},message:"没有定义的错误"},u=e.code;switch(u){case 600:i.style.color="yellow",i.message="等待登录!",t.resolve(i);break;case 603:r({url:e.location,method:"get",headers:{"X-Requested-With":"X-Request-With"}}).success(function(e){var r=e.state||e.status;r&&(s.userInfo=o,i.style.color="green",i.message="登录成功!",d.closeLoginForm(),g(o),n.reload(n.current),t.resolve(i))});break;case 604:i.style.color="blue",i.message="登录成功，账户未绑定!",t.resolve(i);break;case 610:i.style.color="red",i.message="用户名密码不匹配",t.resolve(i);break;case 611:i.style.color="gray",i.message="帐户被锁定",t.resolve(i)}return a}var d={};return d.getScriptInterval=null,d.createLoginForm=function(){if(!d.loginForm){var r="<div hb-login-form></div>",n=o.get("$compile"),a=n(r)(t);d.loginForm=a,e.element("body").append(a)}},d.closeLoginForm=function(){u.cancel(d.getScriptInterval),l.info("关闭获取登录票......"+(new Date).toLocaleString()),this.loginForm&&(this.loginForm.remove(),this.loginForm=void 0)},d.getLoginScript=function(o){return r({url:"/web/login/login/getLoginParameters.action",method:"get"}).success(function(t){var r=$("#_login_script");r.length>0&&(r.remove(),delete window.ssoLogin,delete window.loginThen),window.loginThen=function(e){o.$apply(function(){p(e,o.model).then(function(e){o.model.loginResult=e,u.cancel(d.getScriptInterval)})})};var n=document.createElement("script");n.id="_login_script",n.type="text/javascript",n.src=t.info.casDomain+"/login?TARGET="+t.info.currentDomain+"/web/sso/auth&js&callback=loginThen&"+(new Date).getTime(),e.element("head").append(n)})},d}])});