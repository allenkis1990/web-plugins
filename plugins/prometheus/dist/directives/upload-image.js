/**
 * prometheus - 普罗米修斯
 * @author 
 * @version v1.0.91
 * @link 
 * @license MIT
 */
define(["webuploader","angular"],function(e,r,t){function n(e){throw new Error(e)}return["$timeout","$compile","$log","$parse","$rootScope","HB_notification",function(o,a,i,u,l,f){var s=l.uploadConfigOptions||{};return s.flashUrl=s.flashUrl||"/bower_components/fex-webuploader/dist/Uploader.swf",s.uploadImageUrl||n("please offer "+function(){var e="";return s.uploadImageUrl||(e="uploadImageUrl"),e}()),{require:"ngModel",restrict:"A",link:function(a,i,l,c){function p(e){e.width&&!e.height&&n("please offer scale.height"),!e.width&&e.height&&n("please offer scale.width")}function d(){if(!l.scale)return arguments[2];var e=u(l.scale),t=e(a);if(t){if(r.isArray(t)){for(var n=t.length,o=0;o<n;o++){var i=t[o];p(i),i.type="scale"}return JSON.stringify(t)}return p(t),t.type="scale",JSON.stringify([t])}return arguments[2]}function m(){s.uploadImageUrl.indexOf("?")===-1&&(s.uploadImageUrl+="?1=1");var e=!0,r=[s.uploadImageUrl,"uploadSync="+e],t=d();return t&&r.push("needOperate="+t),r.join("&")}c||n("元素节点上面必须要有ngModel指定对象!");var g=m(),h=function(){var e=u(l.acceptFileType),t=e(a);if(t){if(r.isArray(t))return t.join(",");if(r.isString(t))return t}return arguments[2]}(),v=$.extend({},{disableGlobalDnd:!1,dnd:t,pick:{id:i||t,innerHTML:l.uploadbuttonname!=t&&""!=l.uploadbuttonname?l.uploadbuttonname:"选择文件",multiple:!1},formData:{context:s.context,requestContext:s.requestContext},accept:{title:"files",extensions:h||"jpg,jpeg,bmp,png"},compress:!1,fileSizeLimit:l.limit,auto:!0,swf:s.flashUrl,server:g,threads:3},l);o(function(){var t=e.create(v),n=t;n.on("uploadSuccess",function(e,t){if(l.queueContainerId){var a=l.queueContainerId,i=$("#"+a),u="IMG"===i[0].tagName,f=r.fromJson(t).newPath;i=u?i:i.find("img"),i.attr("src",s.showImageUrl+f),i.show()}o(function(){if(l.valueArray){var e={ImageName:r.fromJson(t).fileName,ImagePath:r.fromJson(t).newPath};c.$viewValue.push(e)}else c.$setViewValue(r.fromJson(t))}),n.reset()}),n.on("beforeFileQueued",function(r){var t=r.ext.toLowerCase(),n=v.accept.extensions;return n.indexOf(t)===-1?(f.alert("请上传"+v.accept.extensions+"格式的图片!"),!1):void(r.formatSize=e.Base.formatSize(r.size))}),n.on("error",function(r){if("Q_EXCEED_SIZE_LIMIT"==r)return f.alert("文件不能超过"+e.Base.formatSize(v.fileSizeLimit)),!1});var i=a.$watch(l.scale,function(e,r){n.option("server",m())},!0);a.$on("$destroy",function(){i()})})}}}]});