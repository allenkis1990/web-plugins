/**
 * prometheus - 普罗米修斯
 * @author 
 * @version v1.0.91
 * @link 
 * @license MIT
 */
define(["webuploader","cropper"],function(e){"use strict";return["$timeout","$log","$rootScope","HB_notification",function(o,t,n,r){var i=n.uploadConfigOptions;return $("head").append('<link href="../bower_components/cropper/dist/cropper.css" rel="stylesheet">'),{scope:{closeVar:"=close",aspectRatio:"=?",mouseWheelZoom:"=?",autoCropArea:"=?",previewSelector:"=?"},require:"ngModel",restrict:"A",templateUrl:function(e,o){return o.templateUrl||"templates/tpls/tpl-upload-head-img-tpl.html"},link:function(t,n,a,p){function l(){return $("<div>加载中</div>").css({background:"#3ca2e2",color:"white",padding:"4px 4px",width:"70px",borderRadius:"4px",position:"absolute",left:"50%",top:"50%",marginLeft:"-40px",marginTop:"-15px",display:"none"})}function u(){var e=d.cropper("getData"),o=f.options.server,t=o+"&needOperate="+function(){var o=[];return e.type="truncate",o.push(e),angular.toJson(o)}();f.option("server",t),f.upload()}if(!i)return!1;var d=$("#image_preview_container"),c=$.extend({},{disableGlobalDnd:!1,dnd:void 0,pick:{id:"#upload_btn",innerHTML:a.buttonText||"选择文件",multiple:!1},formData:{context:i.context,requestContext:i.requestContext},thumb:{quality:70,allowMagnify:!1,crop:!1},accept:{title:"files",extensions:"jpg,png"},compress:!1,auto:!1,swf:i.swf||"/bower_components/fex-webuploader/dist/Uploader.swf",server:i.uploadImageUrl+"?uploadSync="+("undefined"==typeof i.uploadSync||i.uploadSync),threads:3},a),s={fileQueued:"fileQueued",beforeFileQueued:"beforeFileQueued",uploadSuccess:"uploadSuccess",uploadError:"uploadError"},f=new e.Uploader(c);t.uploading=!1,t.windowConfig={title:!1,visible:!0,resizable:!1,draggable:!1,modal:!0,open:function(){var e=665,o=530,t=this.element.parent();t.css({position:"fixed",left:"50%",top:"50%",marginLeft:"-"+e/2+"px",marginTop:"-"+o/2+"px"}),n.show()},close:function(){o(function(){t.closeVar=!1},500)}},t.myloading=l(),n.find(".or-img-box").append(t.myloading),f.on(s.beforeFileQueued,function(){f.reset()}),f.on(s.fileQueued,function(e){f.file=e,t.myloading.show(),f.makeThumb(e,function(e,n){return e?void r.alert("不能预览"):void(t.cropperInstalled?d.cropper("replace",n):o(function(){d.attr("src",n),d.cropper({aspectRatio:t.aspectRatio||1,mouseWheelZoom:!!t.mouseWheelZoom,preview:t.previewSelector||".img-preview",autoCropArea:t.autoCropArea||.65}),t.cropperInstalled=!0,t.myloading.hide()}))},1,1)}),f.on(s.uploadSuccess,function(e,n){o(function(){var e=angular.fromJson(n);p.$setViewValue(e),t.uploading=!1,t.node&&t.node.uploadHeadWindow&&t.node.uploadHeadWindow.close()})}),f.on(s.uploadError,function(e,n){o(function(){e.setStatus("inited "),t.node.uploadHeadWindow.close(),t.uploading=!1})}),t.bigger=function(){d.cropper("zoom","0.1")},t.smaller=function(){d.cropper("zoom","-0.1")},t.leftScale=function(){d.cropper("rotate","-15")},t.rightScale=function(){d.cropper("rotate","15")},t.baseSize=function(){d.cropper("reset")},t.getResult=function(e){if(t.uploading)return!1;e&&e.target&&$(e.target).val("上传中..."),t.uploading=!0;var o=d.cropper("getData"),n=d.get(0).naturalWidth/f.file._info.width;o.scale=n,f.file._cropData={x:o.x,y:o.y,width:o.width,height:o.height,scale:o.scale},u()}}}}]});